syntax = "proto3";

package ihavefood;

option go_package =  "/genproto";

import "google/api/annotations.proto";
// import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";


// ---------------------AUTH SERVICE------------------------------
// Manages user credentials
service AuthService {

    rpc Register(RegisterRequest) returns(UserCredentials) {
        option (google.api.http) = {
            post: "/auth/register" 
            body: "*"
        };
    }

    rpc Login(LoginRequest) returns(LoginResponse){
      option (google.api.http) = {
        post: "/auth/login" 
        body: "*"
      };
    }

    // verify token for role "customer,merchant,rider" returns true if token valid, otherwise false.
    rpc VerifyUserToken(VerifyUserTokenRequest) returns(VerifyUserTokenResponse) {}

    // verify token for role "admin,superadmin" returns true if token valid, otherwise false.
    rpc VerifyAdminToken(VerifyAdminTokenRequest) returns (VerifyAdminTokenResponse){}

    // Check whether username already exists returns true if username already exists, otherwise false.
    rpc CheckUsernameExists(CheckUsernameExistsRequest) returns (CheckUsernameExistsResponse) {}

    // only superadmin role can call this.
    rpc CreateAdmin(CreateAdminRequest) returns(UserCredentials){
        option (google.api.http) = {
            post: "/auth/admin" 
            body: "*"
        };
    }

    /*
        rpc ForgotPassword(ForgotPasswordRequest) returns(ForgotPasswordResponse) {}

        // Retrieves user credentials by username, responding only "USER" role.
        rpc GetUserCredentials() returns(){}   endpoint /auth/users
    */
}

message UserCredentials {
    string id = 1;
    string username = 2;
    string email = 3;
    string password = 4;
    string phone_number = 5;
    Roles role = 6;
    google.protobuf.Timestamp create_time = 7;
    google.protobuf.Timestamp update_time = 8;
}

enum Roles {
    UNKNOWN = 0;
    CUSTOMER = 1;
    MERCHANT = 2;
    RIDER = 3;

    // For simplicity, admin roles are included in this enum.
    SUPER_ADMIN = 20;
    ADMIN = 21;
}

enum Reason {
    REASON_UNSPECIFIED = 0;
    
    // Invalid credentials provided (wrong username/password)
    INVALID_CREDENTIALS = 1000;
    INVALID_TOKEN = 1001;
    TOKEN_EXPIRED = 1002;
    // Token signature verification failed
    TOKEN_SIGNATURE_INVALID = 1003;
    // Required authentication header missing
    MISSING_AUTH_HEADER = 1004;
    // Invalid token format (Bearer token expected)
    INVALID_TOKEN_FORMAT = 1005;
    
    // User doesn't have required role/permission
    INSUFFICIENT_PERMISSIONS = 2000;
    // Action requires admin role but user is not admin
    ADMIN_ROLE_REQUIRED = 2001;
    // Action requires super admin role but user is not super admin
    SUPER_ADMIN_ROLE_REQUIRED = 2002;
    // User role doesn't match expected role for this operation
    ROLE_MISMATCH = 2003;
    
    // Required field is missing or empty
    MISSING_REQUIRED_FIELD = 3000;
    INVALID_FIELD_VALUE = 3001;
    INVALID_USERNAME_FORMAT = 3002;
    INVALID_EMAIL_FORMAT = 3003;
    INVALID_PASSWORD_FORMAT = 3004;
    INVALID_PHONE_FORMAT = 3005;
    INVALID_ROLE = 3006;
    INVALID_ADMIN_ROLE = 10000;
    USERNAME_LENGTH_INVALID = 3007;
    PASSWORD_TOO_SHORT = 3008;
    PASSWORD_COMPLEXITY_INSUFFICIENT = 3009;
    
    USERNAME_ALREADY_EXISTS = 4000;
    EMAIL_ALREADY_EXISTS = 4001;
    PHONE_ALREADY_EXISTS = 4002;
    USER_NOT_FOUND = 5000;
    ADMIN_NOT_FOUND = 5001;
    USERNAME_NOT_FOUND = 5002;
    
    INTERNAL_SERVER_ERROR = 8000;
    DATABASE_ERROR = 8001;
    EXTERNAL_SERVICE_UNAVAILABLE = 8002;
    TOKEN_GENERATION_FAILED = 8003;
    PASSWORD_HASHING_FAILED = 8004;
}

message RegisterRequest {
   string username = 1;
   string email = 2;
   string password = 3;
   string phone_number = 4;
   Roles role = 5;
}

// uncomment this if gateway want to  config code response 
// such as change success code from 200 to 201.
//
// message RegisterResponse {
//    UserCredentials user = 1;
// }

message LoginRequest {
    string identifier = 1;  // username,email, or phone
    string password = 2;
    Roles role = 3;
}

message LoginResponse {
    // Access token. Valid for 30 days.
    string access_token = 1;
    // Number of seconds until the access token expires.
    int64 expires_in = 2;
}

message VerifyUserTokenRequest {
    string access_token = 1;
}

message VerifyUserTokenResponse {
    bool valid = 1;
}

message VerifyAdminTokenRequest {
    string access_token = 1;
}

message VerifyAdminTokenResponse {
    bool valid = 1;
}

message CheckUsernameExistsRequest{
    string username = 1;
}

message CheckUsernameExistsResponse{
    bool exists = 1;
}

message CreateAdminRequest {
   string username = 1;
   string email = 2;
   string password = 3;
   string phone_number = 4;
}

