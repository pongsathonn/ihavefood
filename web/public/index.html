<!-- ----------------------------------------------------------------------------------------------- -->
<!-- ---------------------------------------INDEX--------------------------------------------------- -->
<!-- ----------------------------------------------------------------------------------------------- -->

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>IHAVEFOOD</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
        <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }

        .restaurant-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .restaurant-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .food-item-card {
            transition: transform 0.2s;
        }
        .food-item-card:hover {
            transform: translateY(-2px);
        }
        /* Add a subtle animation for cart visibility */
        .fade-in-up {
            animation: fadeInUp 0.5s ease-in-out;
        }

        @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
        }
        .tracking-step.active .step-dot {
            background-color: #22c55e;
            transform: scale(1.2);
        }
        .tracking-step.active .step-line {
            background-color: #22c55e;
        }
        .tracking-step.active .step-text {
            font-weight: 600;
            color: #1f2937;
        }
        </style>
    </head>
    <body class="flex flex-col min-h-screen">


        <button id="track-button" class="fixed top-20 right-4 p-2 rounded-full bg-gray-200 hover:bg-gray-300 transition z-50 hidden">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
            </svg>
            <span id="track-dot" class="absolute top-0 right-0 block h-2.5 w-2.5 rounded-full bg-red-500 ring-2 ring-white"></span>
        </button>

        <a id="api-button" 
            href="/openapi/"
            target="_blank"
            class="fixed top-6 right-20 px-3 py-2 rounded-full
            bg-gray-200 hover:bg-gray-300 transition
            text-sm font-medium text-gray-700
            flex items-center justify-center z-50 hidden">
            OpenAPI
        </a>

        <!-- Profile/Auth Button - Now fixed to the top-right of the viewport -->
        <button id="profile-button" class="fixed top-6 right-4 p-2 rounded-full bg-gray-200 hover:bg-gray-300 transition z-50 hidden">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
        </button>

        <!--  Main Content Container -->
        <div class="container mx-auto p-4 flex-grow grid grid-cols-1 md:grid-cols-3 gap-6">

            <!-- Header Section (Always Visible) -->
            <header id="main-header" class="text-center py-6 mb-6 relative col-span-1 md:col-span-3">
                <h1 class="text-5xl font-extrabold text-gray-900 tracking-tight">IHAVEFOOD</h1>
                <!-- <p class="text-xl text-gray-500 mt-2">Your favorite food, delivered fast.</p> -->
            </header>

            <!-- Food and Restaurant Content Section -->
            <main id="main-content" class="col-span-1 md:col-span-3">
                <!-- Restaurant List Section -->
                <section id="restaurant-list" class="bg-white p-6 rounded-3xl shadow-lg border border-grey-100 mb-6 hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Restaurants near you</h2>
                    <div id="restaurants-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
                </section>

                <!-- Food Menu Section (Initially Hidden) -->
                <section id="food-menu" class="bg-white p-6 rounded-3xl shadow-lg border border-gray-100 hidden">
                    <div class="flex items-center mb-4">
                        <button id="menu-back-button" class="text-gray-500 hover:text-gray-700 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <h2 id="menu-title" class="text-2xl font-bold text-gray-800 ml-2"></h2>
                    </div>
                    <div id="menu-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Menu items will be injected here by JavaScript -->
                    </div>
                </section>

                <!-- Auth Section (Sign-up/Sign-in) -->
                <section id="auth-section" class="flex items-center justify-center p-6 bg-white rounded-3xl shadow-lg border border-gray-100 max-w-sm mx-auto hidden">
                    <div class="w-full">

                        <form id="signin-form" class="space-y-4">
                            <h2 id="signin-title" class="text-2xl font-bold text-gray-800 mb-6 text-center">Sign In</h2>
                            <p class="text-sm text-gray-500 text-center"></p>
                            <div>
                                <label for="signin-email" class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" id="signin-email" autocomplete="email" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="signin-password" class="block text-sm font-medium text-gray-700">Password</label>
                                <input type="password" id="signin-password"  autocomplete="current-password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <button id="signin-btn" type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200">
                                Sign In
                            </button>
                            <p id="auth-status" class="text-sm mt-2 text-red-500 text-center"></p>
                        </form>

                        <form id="signup-form" class="space-y-4 hidden">
                            <h2 id="signup-title" class="text-2xl font-bold text-gray-800 mb-6 text-center">Sign Up</h2>

                            <div>
                                <label for="signup-email" class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" id="signup-email" autocomplete="email" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <p id="email-register-msg" class="text-sm mt-2 text-red-500 w-full text-left"></p>
                            </div>

                            <div>
                                <label for="signup-password" class="block text-sm font-medium text-gray-700">Password</label>
                                <input type="password" id="signup-password" autocomplete="current-password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <p id="pass-register-msg" class="text-sm mt-2 text-red-500 text-center"></p>
                            </div>

                            <div>
                                <label for="signup-role" class="block text-sm font-medium text-gray-700">I am a...</label>
                                <select id="signup-role" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="customer">Customer</option>
                                    <option value="rider">Rider</option>
                                </select>
                            </div>
                            <button id="signup-btn" type="submit" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200">
                                Sign Up
                            </button>
                        </form>
                        <p id="register-msg" class="text-sm mt-2 text-red-500 text-center"></p>

                        <div class="mt-4 text-center text-sm">
                            <span id="show-signup" class="text-blue-500 hover:underline cursor-pointer">Don't have an account? Sign Up</span>
                            <span id="show-signin" class="text-blue-500 hover:underline cursor-pointer hidden">Already have an account? Sign In</span>
                        </div>

                    </div>
                </section>

                <!-- User Profile Section -->
                <section id="user-profile" class="max-w-xl mx-auto bg-white rounded-3xl shadow-lg p-8 hidden">

                    <!-- Profile Picture -->
                    <div class="flex flex-col items-center mb-8">
                        <div class="w-24 h-24 rounded-full overflow-hidden mb-3 border-2 border-gray-200">
                            <img
                                id="user-picture"
                                src="https://placehold.co/128x128/94a3b8/fff?text=C"
                                alt="User Profile Picture"
                                class="w-full h-full object-cover"
                            />
                        </div>
                        <p
                            id="customer-name"
                            contenteditable="true"
                            class="text-xl font-semibold text-gray-900"
                        >
                            FooCustomer
                        </p>
                    </div>

                    <!-- Customer Info -->
                    <div class="space-y-6 text-sm">

                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <p class="font-semibold text-gray-900">Info</p>
                                <button class="text-blue-600 text-xs hover:underline">Edit</button>
                            </div>

                            <div class="space-y-2">
                                <div class="flex items-center">
                                    <span class="text-gray-500 w-24">CustomerID</span>
                                    <span id="customer-id" class="text-gray-900">TODO</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="text-gray-500 w-24">Email</span>
                                    <span id="customer-email" class="text-gray-900">TODO</span>
                                </div>

                                <div class="flex items-center gap-3">
                                    <span class="text-gray-500 w-24">Phone</span>

                                    <input
                                        type="text"
                                        id="customer-phone"
                                        value="TODO"
                                        class="flex-1 rounded-lg border border-gray-300 bg-gray-50 px-3 py-2
                                        text-gray-900 transition
                                        focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none"
                                    >
                                </div>
                            </div>

                            <div class="flex space-x-2 justify-end">
                                <button class="px-3 py-1 text-xs font-medium text-gray-600 bg-gray-100 rounded hover:bg-gray-200">Cancel</button>
                                <button class="px-3 py-1 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700">Save</button>
                            </div>
                        </div>

                        <!-- Divider -->
                        <div class="border-t border-gray-200"></div>

                        <!-- Social -->
                        <div class="space-y-2">
                            <p class="font-semibold text-gray-900 mb-3">Social</p>
                            <div class="flex">
                                <span class="text-gray-500 w-24">Facebook</span>
                                <span id="social-facebook" class="text-gray-900">TODO</span>
                            </div>
                            <div class="flex">
                                <span class="text-gray-500 w-24">Instagram</span>
                                <span id="social-instagram" class="text-gray-900">TODO</span>
                            </div>
                            <div class="flex">
                                <span class="text-gray-500 w-24">LINE</span>
                                <span id="social-line" class="text-gray-900">TODO</span>
                            </div>
                        </div>

                        <!-- Divider -->
                        <div class="border-t border-gray-200"></div>

                        <div class="max-w-md mx-auto">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-900 text-lg">My Address</h3>
                                <button id="add-btn" class="text-sm font-medium text-blue-600 hover:text-blue-700">+ Add New</button>
                            </div>
                            <div id="address-list" class="space-y-3"></div>
                        </div>

                        <!-- Sign Out -->
                        <button
                        id="signout-btn"
                        class="mt-8 w-full bg-red-500 hover:bg-red-600 text-white font-medium py-3 rounded transition"
                    >
                        Sign Out
                    </button>

                </section>

                <!-- Order Tracking Section (Initially Hidden) -->
                <section id="order-tracking-section" class="bg-white p-6 rounded-3xl shadow-lg border border-gray-100 hidden col-span-1 md:col-span-3">
                    <div class="flex items-center mb-4">
                        <button id="tracking-back-button" class="text-gray-500 hover:text-gray-700 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <h2 class="text-2xl font-bold text-gray-800 ml-2">Order Tracking</h2>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                        <!-- Left Column: Map and Status -->
                        <div class="space-y-6">
                            <!-- Order Status -->
                            <div class="bg-gray-50 p-6 rounded-2xl border border-gray-200 shadow-sm">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">Order Status</h3>
                                <div class="flex items-center justify-between relative">
                                    <!-- Step 1 -->
                                    <div class="tracking-step w-1/4 flex flex-col items-center relative active" id="step-1">
                                        <div class="step-dot w-6 h-6 rounded-full bg-pink-500 border-4 border-white transition-all duration-[3000ms]"></div>
                                        <span class="step-text text-xs text-center text-gray-600 mt-2 transition-all duration-[3000ms]">Order Placed</span>
                                    </div>


                                    <!-- Step 2 -->
                                    <div class="tracking-step w-1/4 flex flex-col items-center relative" id="step-2">
                                        <div class="step-dot w-6 h-6 rounded-full bg-gray-300 border-4 border-white transition-all duration-[3000ms]"></div>
                                        <span class="step-text text-xs text-center text-gray-600 mt-2 transition-all duration-[3000ms]">Preparing Food</span>
                                    </div>
                                    <!-- Line 1 -->
                                    <div class="step-line absolute h-1 bg-gray-300 top-3 left-[12.5%] right-[62.5%] transition-all duration-[3000ms]"></div>


                                    <!-- Step 3 -->
                                    <div class="tracking-step w-1/4 flex flex-col items-center relative" id="step-3">
                                        <div class="step-dot w-6 h-6 rounded-full bg-gray-300 border-4 border-white transition-all duration-[3000ms]"></div>
                                        <span class="step-text text-xs text-center text-gray-600 mt-2 transition-all duration-[3000ms]">Rider on the Way</span>
                                    </div>
                                    <!-- Line 2 -->
                                    <div class="step-line absolute h-1 bg-gray-300 top-3 left-[37.5%] right-[37.5%] transition-all duration-[3000ms]"></div>


                                    <!-- Step 4 -->
                                    <div class="tracking-step w-1/4 flex flex-col items-center relative" id="step-4">
                                        <div class="step-dot w-6 h-6 rounded-full bg-gray-300 border-4 border-white transition-all duration-[3000ms]"></div>
                                        <span class="step-text text-xs text-center text-gray-600 mt-2 transition-all duration-[3000ms]">Delivered</span>
                                    </div>
                                    <!-- Line 3 -->
                                    <div class="step-line absolute h-1 bg-gray-300 top-3 left-[62.5%] right-[12.5%] transition-all duration-[3000ms]"></div>

                                </div>

                            </div>

                            <!-- Map Placeholder -->
                            <div class="bg-gray-100 rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
                                <iframe 
                                    src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3777.8896428156843!2d98.99113197587258!3d18.78778006195882!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x30da3a7e90bb6f5d%3A0x8e4e6c5c6de1f11d!2sTha%20Phae%20Gate!5e0!3m2!1sen!2sth!4v1734000000000!5m2!1sen!2sth" 
                                    width="100%" 
                                    height="400" 
                                    style="border:0;" 
                                    allowfullscreen="" 
                                    loading="lazy" 
                                    referrerpolicy="no-referrer-when-downgrade"
                                    class="rounded-2xl"
                                ></iframe>
                                <div class="p-4 bg-gray-50 text-center">
                                    <p class="text-sm text-red-600">**Map feature not implemented yet</p>
                                </div>
                            </div>

                        </div>

                        <!-- Right Column: Order & Rider Details -->
                        <div class="space-y-6">
                            <!-- Order Summary -->
                            <div class="bg-gray-50 p-6 rounded-2xl border border-gray-200 shadow-sm">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">Order Details</h3>
                                <div class="space-y-2 text-gray-600 text-sm">
                                    <div class="flex justify-between">
                                        <span class="font-semibold">Order ID:</span>
                                        <span id="tracking-order-id"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="font-semibold">Restaurant:</span>
                                        <span id="tracking-restaurant-name"></span>
                                    </div>

                                    <div class="flex justify-between items-start">
                                        <span class="font-semibold">Foods:</span>
                                        <div id="tracking-food-items" class="flex flex-col items-end space-y-1 w-40"></div>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="font-semibold">Total:</span>
                                        <span id="tracking-order-total"></span>
                                    </div>

                                    <!-- <div class="flex justify-between"> -->
                                    <!--     <span class="font-semibold">Est. Delivery:</span> -->
                                    <!--     <span id="tracking-eta">15-20 mins</span> -->
                                    <!-- </div> -->

                                </div>
                            </div>

                            <!-- Rider Information -->
                            <div class="bg-gray-50 p-6 rounded-2xl border border-gray-200 shadow-sm">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">Rider Information</h3>
                                <div class="flex items-center space-x-4">
                                    <img src="https://placehold.co/80x80/6366f1/fff?text=Rider" alt="Rider Profile" class="w-20 h-20 rounded-full object-cover">
                                    <div>
                                        <p class="text-lg font-semibold text-gray-800" id="rider-name">Demo Rider</p>
                                        <p class="text-sm text-gray-500" id="rider-vehicle">Honda Click 125i (กข1234)</p>
                                        <a href="tel:0812345678" class="text-blue-500 hover:underline text-sm flex items-center mt-1">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                            </svg>
                                            Call Rider
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <!-- Problem Reporting -->
                            <div class="bg-gray-50 p-6 rounded-2xl border border-gray-200 shadow-sm text-center">
                                <p class="text-sm text-gray-600 mb-3">Having an issue with your order?</p>
                                <button class="bg-red-500 text-white font-bold py-2 px-6 rounded-full hover:bg-red-600 transition">
                                    Report a Problem
                                </button>
                            </div>
                        </div>
                    </div>


                </section>

            </main>

            <!-- Shopping Cart Section (Initially Hidden) -->
            <aside id="cart-aside" class="col-span-1 hidden">
                <div class="bg-white p-6 rounded-3xl shadow-lg border border-gray-100 sticky top-40">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Cart</h2>
                    <div id="cart-items" class="min-h-[100px] mb-4">
                        <p id="empty-cart-message" class="text-gray-500 italic text-sm">Your cart is empty.</p>
                        <!-- Cart items will be injected here by JavaScript -->
                    </div>

                    <!-- Coupon Section -->
                    <div class="mt-4 mb-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Coupons</h3>

                        <div class="flex flex-wrap gap-2 mt-2 mb-2">
                            <button class="preset-coupon-btn bg-gray-200 text-xs px-2 py-1 rounded hover:bg-gray-300" data-coupon="SAVE10">SAVE10</button>
                            <button class="preset-coupon-btn bg-gray-200 text-xs px-2 py-1 rounded hover:bg-gray-300" data-coupon="SAVE50">SAVE50</button>
                            <button class="preset-coupon-btn bg-gray-200 text-xs px-2 py-1 rounded hover:bg-gray-300" data-coupon="FREEDELIVERY">FREEDELIVERY</button>
                        </div>

                        <div class="flex items-center space-x-2 flex-nowrap">
                            <input type="text" id="coupon-input" placeholder="Code" 
                                class="min-w-0 flex-grow p-2 rounded-lg border border-gray-300 focus:outline-none focus:border-blue-500 text-sm">

                            <button id="apply-coupon-btn" 
                                class="flex-shrink-0 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition disabled:bg-gray-400 text-sm" 
                                disabled>
                                Apply
                            </button>
                        </div>
                        <p id="coupon-status" class="text-sm mt-2"></p>
                    </div>

                    <div class="border-t pt-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-lg font-semibold text-gray-800">Food:</span>
                            <span id="cart-food" class="text-lg font-bold text-gray-600">฿0.00</span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-lg font-semibold text-gray-800">Delivery Fee:</span>
                            <span id="cart-delivery" class="text-lg font-bold text-gray-600">฿0.00</span>
                        </div>
                        <div id="discount-row" class="flex justify-between items-center mb-2 hidden">
                            <span class="text-lg font-semibold text-gray-800">Discount:</span>
                            <span id="cart-discount" class="text-lg font-bold text-red-500">-฿0.00</span>
                        </div>
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-lg font-semibold text-gray-800">Total:</span>
                            <span id="cart-total" class="text-xl font-bold text-pink-600">฿0.00</span>
                        </div>
                        <button id="order-button" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-full transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-pink-400 focus:ring-opacity-50 shadow-md disabled:bg-pink-400" disabled>
                            Place Order
                        </button>
                    </div>
                </div>
            </aside>

            <!-- Footer Credit -->
            <!-- <footer class="text-center py-4 text-xl text-gray-500"> credit </footer> -->

        </div>


        <!-- Order Confirmation Modal -->
        <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
            <div class="bg-white p-8 rounded-3xl shadow-lg w-full max-w-sm text-center">
                <svg class="mx-auto h-16 w-16 text-pink-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Order Placed!</h3>
                <p class="text-gray-600 mb-4">Your food is on its way. Thank you for your order!</p>
                <button id="track-order-button" class="bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200 mt-2 mr-2">
                    Track Order
                </button>
                <button id="close-modal-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200">
                    Close
                </button>
            </div>
        </div>

        <!-- Register Success Modal -->
        <div id="modal-register" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
            <div class="relative bg-white p-8 rounded-3xl shadow-lg w-full max-w-sm text-center">

                <!-- Close button -->
                <button
                    onclick="document.getElementById('modal-register').classList.add('hidden')"
                    class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"
                    aria-label="Close"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>

                <svg class="mx-auto h-16 w-16 text-green-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>

                <h3 class="text-xl font-bold text-gray-800 mb-2">
                    Successfully registered!
                </h3>
            </div>
        </div>


        <div id="loader" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50">
            <div class="w-10 h-10 border-4 border-gray-300 border-t-blue-600 rounded-full animate-spin"></div>
            <p class="mt-4 text-sm text-gray-500">Loading...</p>
        </div>

        <!-- ----------------------------------------------------------------------------------------------- -->
        <!-- ---------------------------------------JavaScript---------------------------------------------- -->
        <!-- ----------------------------------------------------------------------------------------------- -->

        <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";
        const firebaseConfig = {
            storageBucket: "ihavefood-ee231.firebasestorage.app",
        };
        const app = initializeApp(firebaseConfig);
        const serverUrl = "https://api-gateway-731964455549.asia-southeast1.run.app"
        const DEFAULT_ADDRESS_NAME = "New Address";

        // --- Static Data ---
        let isUserAuthenticated = false;
        // The cart is now an object, storing a separate cart array for each restaurant
        let localCart = {};
        let currentRestaurant = null;
        let isCustomerLogin = false;
        let isOrderPlaced = false;
        let cachedData = null;

        // --- UI Element References ---
        const mainContent = document.getElementById('main-content');
        const mainHeader = document.getElementById('main-header');
        const restaurantsContainer = document.getElementById('restaurants-container');
        const foodMenuSection = document.getElementById('food-menu');
        const userProfileSection = document.getElementById('user-profile');
        const restaurantListSection = document.getElementById('restaurant-list');
        const orderTrackingSection = document.getElementById('order-tracking-section');
        const authSection = document.getElementById('auth-section');
        const signinTitle = document.getElementById("signin-title");
        const signupTitle = document.getElementById("signup-title");
        const menuTitle = document.getElementById('menu-title');
        const menuContainer = document.getElementById('menu-container');
        const menuBackButton = document.getElementById('menu-back-button');
        const trackingBackButton = document.getElementById('tracking-back-button');
        const apiButton = document.getElementById('api-button');
        const trackButton = document.getElementById('track-button');
        const trackDot = document.getElementById('track-dot');
        const profileButton = document.getElementById('profile-button');
        const signoutButton = document.getElementById('signout-btn');
        const signinForm = document.getElementById('signin-form');
        const signupForm = document.getElementById('signup-form');

        const signinEmailInput = document.getElementById('signin-email');
        const signinPasswordInput = document.getElementById('signin-password');

        const signupEmailInput = document.getElementById('signup-email');
        const signupPasswordInput = document.getElementById('signup-password');
        const signupRoleSelect = document.getElementById('signup-role');

        // const signinBtn = document.getElementById('signin-btn');
        // const signupBtn = document.getElementById('signup-btn');

        const infoEmail = document.getElementById('info-email');
        const infoPhone = document.getElementById('info-phone');
        const socialFacebook = document.getElementById('social-facebook');
        const socialInstagram = document.getElementById('social-instagram');
        const socialLine =  document.getElementById('social-line');

        const addPhoneBtn = document.getElementById('add-phone');

        const authStatus = document.getElementById('auth-status');

        const emailRegisterMsg = document.getElementById('email-register-msg');
        const passRegisterMsg = document.getElementById('pass-register-msg');
        const registerMsg = document.getElementById('register-msg');

        const showSignupLink = document.getElementById('show-signup');
        const showSigninLink = document.getElementById('show-signin');
        const cartAside = document.getElementById('cart-aside');
        const cartItemsContainer = document.getElementById('cart-items');
        const cartFoodElement = document.getElementById('cart-food');
        const cartDeliveryElement = document.getElementById('cart-delivery');
        const cartDiscountElement = document.getElementById('cart-discount');
        const cartTotalElement = document.getElementById('cart-total');
        const discountRow = document.getElementById('discount-row');
        const orderButton = document.getElementById('order-button');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const modal = document.getElementById('modal');
        const modalRegister = document.getElementById('modal-register');
        const closeModalButton = document.getElementById('close-modal-button');
        const trackOrderButton = document.getElementById('track-order-button');
        const couponInput = document.getElementById('coupon-input');
        const applyCouponBtn = document.getElementById('apply-coupon-btn');
        const couponStatus = document.getElementById('coupon-status');
        const userIdDisplay = document.getElementById('user-id');
        const trackingSteps = document.querySelectorAll('.tracking-step');

        const trackingOrderId = document.getElementById("tracking-order-id");
        const trackingRestaurantName = document.getElementById("tracking-restaurant-name");
        const trackingFoodItems = document.getElementById("tracking-food-items");
        const trackingOrderTotal = document.getElementById("tracking-order-total");


        const presetCouponButtons = document.querySelectorAll('.preset-coupon-btn');
        let couponApplied = false;

        let addresses = [];

        const addressList = document.getElementById('address-list');
        const addBtn = document.getElementById('add-btn');
        

        // id = AddressID
        // value = exist address value
        function createInput(label, id, value = '', type = 'text', placeholder = '') {
            return `
            <div>
                <label for="${id}" class="block text-sm font-medium text-gray-700 mb-1">
                    ${label}
                </label>
                <input
                    type="${type}"
                    id="${id}"
                    value="${value}"
                    placeholder="${placeholder}"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
            </div>
        `;
        }


         // TODO: render default address first
         const renderAddresses = async () => {

            isAddingNew = false;
            addressList.innerHTML = '';
            const sortedAddresses = [...addresses].sort((a, b) => b.isDefault - a.isDefault);

            sortedAddresses.forEach(addr => {
                const card = document.createElement('div');
                card.className = 'address-card relative p-4 border border-gray-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 transition-colors';
                card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <span class="font-bold text-gray-900">${addr.addressName}</span>
                        ${addr.isDefault ? '<span class="ml-2 px-2 py-0.5 text-xs font-medium bg-green-100 text-green-700 rounded-full">Default</span>' : ''}
                    </div>
                    <div class="flex space-x-3">
                        <button data-edit="${addr.addressId}" class="text-gray-400 hover:text-blue-600"><small>Edit</small></button>
                        <button data-delete="${addr.addressId}" class="text-gray-400 hover:text-red-600"><small>Delete</small></button>
                    </div>
                </div>
                <div class="text-gray-600 text-sm leading-relaxed">
                    <p>${addr.subDistrict}, ${addr.district}</p>
                    <p>${addr.province}, <span class="font-medium">${addr.postalCode}</span></p>
                </div>
                `;
                addressList.appendChild(card);
            });
        }

        async function handleSaveAddress(id, isNew, event) {
            const addressLine = document.getElementById(`name-${id}`);
            const subDistrict = document.getElementById(`sub-${id}`);
            const district = document.getElementById(`district-${id}`);
            const province = document.getElementById(`province-${id}`);
            const postal = document.getElementById(`postal-${id}`);

            // Reset previous error styles
            [addressLine, subDistrict, district, province, postal].forEach(el => el.classList.remove('border-red-500'));

            let hasError = false;

            if (!addressLine.value) { addressLine.classList.add('border-red-500'); hasError = true; }
            if (!subDistrict.value) { subDistrict.classList.add('border-red-500'); hasError = true; }
            if (!district.value) { district.classList.add('border-red-500'); hasError = true; }
            if (!province.value) { province.classList.add('border-red-500'); hasError = true; }
            if (!postal.value) { postal.classList.add('border-red-500'); hasError = true; }

            if (hasError) return; // stop saving

            const button = event.target;
            button.disabled = true;
            button.textContent = 'Saving...';

            try {
                await saveAddress(id, isNew);
            } catch (error) {
                console.error('Error saving address:', error);
                alert('Failed to save address. Please try again.');
            } finally {
                button.disabled = false;
                button.textContent = isNew ? 'Add' : 'Save';
            }
        }

        async function saveAddress(addrID, isNew = false) {
            isAddingNew = false;

            const customerID = localStorage.getItem('customer_id');

            const addressLine = document.getElementById(`name-${addrID}`).value;
            const subDistrict = document.getElementById(`sub-${addrID}`).value;
            const district = document.getElementById(`district-${addrID}`).value;
            const province = document.getElementById(`province-${addrID}`).value;
            const postal = document.getElementById(`postal-${addrID}`).value;
            let isDefault = document.getElementById(`default-${addrID}`).checked;

            if (isNew) {
                const res = await createAddress({
                    customer_id: customerID,
                    address: {
                        address_name: addressLine,
                        sub_district: subDistrict,
                        district: district,
                        province: province,
                        postal_code: postal
                    }
                });

                console.log('CREATE response:', res); // DEBUG

                if (isDefault) {
                    addresses.forEach(a => a.isDefault = false);
                }

                addresses.push({ 
                    addressId: res.addressId,
                    addressName: res.addressName,
                    subDistrict: res.subDistrict,
                    district: res.district,
                    province: res.province,
                    postalCode: res.postalCode,
                    isDefault
                });

            } else {

                const res = await updateAddress({
                    customer_id: customerID,
                    address_id: addrID,
                    address: {
                        address_name: addressLine,
                        sub_district: subDistrict,
                        district: district,
                        province: province,
                        postal_code: postal
                    }
                });

                if (isDefault) {
                    addresses.forEach(a => a.isDefault = false);
                }

                const addressToUpdate = addresses.find(a => a.addressId === addrID);
                if (addressToUpdate) {
                    Object.assign(addressToUpdate, {
                        addressName: res.addressName,
                        subDistrict: res.subDistrict,
                        district: res.district,
                        province: res.province,
                        postalCode: res.postalCode,
                        isDefault
                    });
                }
            }

            if (addresses.length === 1) {
                addresses[0].isDefault = true;
            }

            renderAddresses();
        }

        // editing form used by both '+ Add New' and 'Edit' button
        function editAddress(id, isNew = false) {

            addressList.innerHTML = '';
            const addr = isNew ? {} : addresses.find(a => a.addressId === id) || {};

            const card = document.createElement('div');
            card.className = 'address-card relative p-4 border border-blue-300 bg-blue-50 rounded-lg';

            card.innerHTML = `
                ${createInput('Address Line', `name-${id}`, addr.addressName || '', 'text', 'House no. / Moo / Soi / Road')}
                <div class="grid grid-cols-2 gap-3">
                    ${createInput('Sub-district', `sub-${id}`, addr.subDistrict || '', 'text', 'e.g., Suthep')}
                    ${createInput('District', `district-${id}`, addr.district || '', 'text', 'e.g., Mueang Chiang Mai')}
                </div>
                <div class="grid grid-cols-2 gap-3">
                    ${createInput('Province', `province-${id}`, addr.province || '', 'text', 'e.g., Chiang Mai')}
                    ${createInput('Postal Code', `postal-${id}`, addr.postalCode || '', 'text', 'e.g., 50200')}
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" id="default-${id}" ${addr.isDefault ? 'checked' : ''} class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                    <label for="default-${id}" class="ml-2 text-sm text-gray-700">Set as default</label>
                </div>
                
                <div class="flex space-x-2 pt-2">
                    <button onclick="handleSaveAddress('${id}', ${isNew}, event)" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">${isNew ? 'Add' : 'Save'}</button>
                    <button onclick="renderAddresses()" class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">Cancel</button>
                </div>
                `;

            addressList.appendChild(card);
        }

        // Event delegation
        addressList.addEventListener('click', e => {
            const editBtn = e.target.closest('button[data-edit]');
            const deleteBtn = e.target.closest('button[data-delete]');

            if (editBtn) {
                const card = editBtn.closest('.address-card');
                editAddress(editBtn.dataset.edit, false);
                return;
            }

            if (deleteBtn && confirm('Delete this address?')) {
                // addresses = addresses.filter(a => a.id !== Number(deleteBtn.dataset.delete));
                addresses.filter(a => a.addressId !== deleteBtn.dataset.delete)
                renderAddresses();
            }

        });


        let isAddingNew = false;
        addBtn.addEventListener('click', () => {

            const MAX_ADDR = 5;
            if (addresses.length >= MAX_ADDR) {
                alert(`You’ve reached the maximum saved addresses.`);
                return;
            }

            // prevent multiple forms
            if (isAddingNew) return; 
            isAddingNew = true;

            // If a new address form already exists, do nothing
            if (document.querySelector('.address-card.new-address')) return;

            editAddress(null, true);
        });


        // --- UI Rendering Functions ---
        const showSection = (sectionId) => {

            if (!isOrderPlaced) {
                trackButton.classList.add('opacity-40', 'pointer-events-none');
            } else {
                trackButton.classList.remove('opacity-40', 'pointer-events-none');
            }

            const sections = [restaurantListSection, foodMenuSection, userProfileSection, authSection, orderTrackingSection];
            sections.forEach(section => {
                section.style.display = (section.id === sectionId) ? 'block' : 'none';
            });

            // Update the main content layout based on which section is visible
            if (sectionId === 'food-menu') {
                mainContent.classList.remove('md:col-span-3');
                mainContent.classList.add('md:col-span-2');
                cartAside.classList.remove('hidden');
            }else if ( sectionId === 'order-tracking-section' || sectionId === 'auth-section' ){

                trackButton.classList.add('hidden');
                trackDot.classList.add('hidden');
                profileButton.classList.add('hidden');
                apiButton.classList.add('hidden');

                mainContent.classList.remove('md:col-span-2');
                mainContent.classList.add('md:col-span-3');
                cartAside.classList.add('hidden');
            } else {

                mainContent.classList.remove('md:col-span-2');
                mainContent.classList.add('md:col-span-3');

                trackButton.classList.remove('hidden');
                profileButton.classList.remove('hidden');
                apiButton.classList.remove('hidden');

                cartAside.classList.add('hidden');
            }
        };

        const renderRestaurants = async () => {
            let merchants = cachedData.merchants;
            restaurantsContainer.innerHTML = '';

            if (merchants.length === 0) {
                restaurantsContainer.innerHTML = '<p class="text-gray-500 italic">No restaurants available.</p>';
                return;
            }

            if (addresses.length === 0) {
                restaurantsContainer.innerHTML = `<div class="col-span-full flex items-center justify-center min-h-[300px] text-gray-400 text-2xl">
                    Please update your delivery address to see nearby restaurants.
                </div>`;
                return;
            }

            const storage = getStorage();
            const deliveryFees = {};

            for (const merchant of merchants) {
                const customerId = localStorage.getItem("customer_id");

                const defaultAddr = addresses.find(a => a.isDefault);
                if (!defaultAddr) {
                    console.error('No default address found');
                    return;
                }
                const customerAddrId = defaultAddr.addressId;

                const merchantId = merchant.merchantId

                const url =
                    `${serverUrl}/api/deliveries/fee` +
                        `?customer_id=${customerId}` +
                        `&customer_address_id=${customerAddrId}` +
                        `&merchant_id=${merchantId}`;
                const res = await fetch(url,{
                    method: "GET",
                    headers: { "Accept": "application/json" }
                });
                const { fee = 10 } = await res.json(); // Default to 10 instead of 0
                deliveryFees[merchantId] = fee;

                // Reverse calculate distance from fee with some randomness
                // Formula: distance = (fee - 10) / 1.6
                const baseDistance = (fee - 10) / 1.6;
                const randomVariation = (Math.random() * 2) - 1; // ±1 km variation
                const distance = Math.max(0, Math.min(25, baseDistance + randomVariation)).toFixed(1);

                // Calculate fake ETA based on distance (1-60 minutes)
                const distanceNum = parseFloat(distance);
                const baseEta = Math.round((distanceNum / 30) * 60); // Convert to minutes
                const etaVariation = Math.floor(Math.random() * 10) - 5; // ±5 minutes
                const eta = Math.max(1, Math.min(60, baseEta + etaVariation)); // Clamp between 1-60

                let imageUrl = '';
                try {
                    imageUrl = await getDownloadURL(
                        ref(storage, merchant.imageInfo.url)
                    );
                } catch (err) {
                    console.error(err);
                }
                const card = document.createElement('div');

                const isClosed = merchant.status === 'STORE_STATUS_CLOSED';

                card.className = `restaurant-card bg-gray-50 rounded-2xl shadow-sm overflow-hidden cursor-pointer hover:shadow-lg ${isClosed ? 'opacity-50 pointer-events-none' : ''}`;
                card.innerHTML = `
<img src="${imageUrl}" alt="${merchant.merchantName}" class="w-full h-[220px] object-cover">
<div class="p-4">
    <h3 class="text-lg font-semibold text-gray-800">${merchant.merchantName}</h3>

    ${!isClosed ? `
    <p class="text-sm text-gray-500">
        Delivery: <span class="text-red-700">฿${fee}</span>
        <span class="text-gray-200">|</span>
        ${distance} km (${eta} min)
    </p>
    ` : ''}

    <p class="text-sm text-gray-500">Status: ${isClosed ? 'CLOSED' : 'OPEN'}</p>
</div>
`;

                if (!isClosed) {
                    card.addEventListener('click', () => {
                        currentRestaurant = merchant;

                        localStorage.setItem('selected_merchant_id', merchant.merchantId);
                        localStorage.setItem('selected_merchant_name', merchant.merchantName);
                        localStorage.setItem('delivery_fee', fee);

                        cartDeliveryElement.textContent = `฿${fee}`;

                        menuTitle.textContent = currentRestaurant.merchantName;
                        renderMenu(currentRestaurant.menu);
                        renderCart(); // Render the cart for the selected restaurant
                        showSection('food-menu');
                    });
                }
                restaurantsContainer.appendChild(card);
            }
            localStorage.setItem('deliveryFees', JSON.stringify(deliveryFees));
        };

        const renderMenu = async (menu) => {
            menuContainer.innerHTML = '';
            if (!menu || menu.length === 0) {
                menuContainer.innerHTML = '<p class="text-gray-500 italic">This restaurant has no menu items.</p>';
                return;
            }

            for (const item of menu ) { 

                const storage = getStorage();
                let imageUrl = '';
                try {
                    imageUrl = await getDownloadURL(
                        ref(storage, item.imageInfo.url)
                    );
                } catch (err) {
                    console.error(err);
                }
                const card = document.createElement('div');
                card.className = 'food-item-card ...';

                card.innerHTML = `
<div class="flex items-center space-x-4">
    <img src="${imageUrl}" alt="${item.foodName}" class="w-16 h-16 object-cover rounded-lg">
    <div>
        <h4 class="text-md font-semibold text-gray-800">${item.foodName}</h4>
        <span class="text-sm text-gray-500">฿${(item.price).toFixed(2)}</span>
    </div>
</div>
<button class="add-to-cart-btn ..." data-item='${JSON.stringify(item)}'>Add</button>
`;
                menuContainer.appendChild(card);
            }
        };

        const renderCart = () => {
            cartItemsContainer.innerHTML = '';
            const currentCart = localCart[currentRestaurant.merchantId] || [];

            if (currentCart.length === 0) {
                emptyCartMessage.style.display = 'block';
            } else {
                emptyCartMessage.style.display = 'none';
                currentCart.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'flex justify-between items-center py-2 border-b last:border-b-0 text-sm';
                    itemElement.innerHTML = `
<span>${item.foodName} <span class="text-gray-500">(${item.quantity})</span></span>
<div class="flex items-center space-x-2">
    <span class="font-semibold">฿${(item.price * item.quantity).toFixed(2)}</span>
    <button class="remove-from-cart-btn text-red-500 hover:text-red-600 transition" data-item-id="${item.itemId}">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.038 21H7.962a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
        </svg>
    </button>
</div>
`;
                    cartItemsContainer.appendChild(itemElement);
                });
            }
            updateCartTotals();
        };

        const updateCartTotals = () => {
            const currentCart = localCart[currentRestaurant.merchantId] || [];
            const food = currentCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const couponPercent = localStorage.getItem('coupon_percent');
            const deliveryFee =  Number(localStorage.getItem('delivery_fee'));
            let discountAmount = 0;

            cartFoodElement.textContent = `฿${food.toFixed(2)}`;

            if (couponApplied) {
                const couponCode = couponInput.value.trim().toUpperCase();
                if (couponCode === "FREEDELIVERY") {

                    // cartDeliveryElement.textContent = `-฿${deliveryFee}`;
                    // cartDeliveryElement.className = 'text-lg font-bold text-red-500';

                    discountAmount = deliveryFee;
                    discountRow.classList.remove('hidden');
                    cartDiscountElement.textContent = `-฿${discountAmount}`;

                } else if (couponPercent > 0) {

                    // Reset delivery display to normal
                    // cartDeliveryElement.textContent = `฿${deliveryFee}`;
                    // cartDeliveryElement.className = 'text-lg font-bold text-gray-600';

                    discountAmount = food * (couponPercent / 100);
                    discountRow.classList.remove('hidden');
                    cartDiscountElement.textContent = `-฿${discountAmount}`;
                }
            } else {
                // No coupon applied
                discountAmount = 0;
                cartDeliveryElement.textContent = `฿${deliveryFee}`;
                cartDeliveryElement.className = 'text-lg font-bold text-gray-600';
                discountRow.classList.add('hidden');
            }
            localStorage.setItem('discount', discountAmount);

            const total = food + deliveryFee - discountAmount;
            cartTotalElement.textContent = `฿${total.toFixed(2)}`;

            orderButton.disabled = food === 0 || isOrderPlaced;
        };


        const addToCart = (foodItem) => {

            const restaurantId = currentRestaurant.merchantId;
            if (!localCart[restaurantId]) {
                localCart[restaurantId] = [];
            }
            const currentCart = localCart[restaurantId];
            const existingItem = currentCart.find(item => item.itemId === foodItem.itemId);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                currentCart.push({ ...foodItem, quantity: 1 });
            }

            renderCart();
        };

        const removeFromCart = (itemId) => {
            const restaurantId = currentRestaurant.merchantId;
            const currentCart = localCart[restaurantId] || [];
            const itemIndex = currentCart.findIndex(item => item.itemId === itemId);
            if (itemIndex !== -1) {
                const item = currentCart[itemIndex];
                if (item.quantity > 1) {
                    item.quantity--;
                } else {
                    currentCart.splice(itemIndex, 1);
                }
            }
            renderCart();
        };

        const showModal = () => {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        const showModalRegister = () => {
            modalRegister.classList.remove('hidden');
            modalRegister.classList.add('flex');
        };

        const hideModal = () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            modalRegister.classList.add('hidden');
            modalRegister.classList.remove('flex');
        };

        const setTrackingStep = (stepNumber) => {
            trackingSteps.forEach((step, index) => {
                if (index < stepNumber) {
                    step.classList.add('active');
                    const line = step.nextElementSibling;
                    if (line && line.classList.contains('step-line')) {
                        line.classList.add('bg-green-500');
                        line.classList.remove('bg-gray-300');
                    }
                } else {
                    step.classList.remove('active');
                    const line = step.nextElementSibling;
                    if (line && line.classList.contains('step-line')) {
                        line.classList.remove('bg-green-500');
                        line.classList.add('bg-gray-300');
                    }
                }
            });
        };

        const buildOrderPayload = () => {
            const restaurantId = currentRestaurant.merchantId;
            const customerId = localStorage.getItem('customer_id');
            const appliedCoupon = localStorage.getItem('applied_coupon');
            const discount = Number(localStorage.getItem('discount'));
            const customerAddresses = JSON.parse(localStorage.getItem('customer_addresses') || "[]");
            const customerAddressId = customerAddresses[0]?.addressId; // or let user choose later

            const cartItems = (localCart[restaurantId] || []).map(item => ({
                item_id: item.itemId,
                quantity: item.quantity,
                note: item.note || ""
            }));

            const orderPayload = {
                request_id: crypto.randomUUID(),
                customer_id: customerId,
                merchant_id: restaurantId,
                items: cartItems,
                coupon_code: appliedCoupon,
                discount: discount,
                customer_address_id: customerAddressId,
                payment_methods: "PAYMENT_METHOD_CREDIT_CARD"
            };

            return orderPayload;
        };

        const updateAddress = async (payload) => {
            const res = await fetch(`${serverUrl}/api/customers/${payload.customer_id}/addresses/${payload.address_id}`, {
                method: "PATCH",
                headers: {
                    "Accept": "application/json",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const errorText = await res.text();
                throw new Error(`Failed to update customer address: ${errorText}`);
            }

            return await res.json();
        };

        const createAddress = async (payload) => {
            const res = await fetch(`${serverUrl}/api/customers/${payload.customer_id}/address`, {
                method: "POST",
                headers: {
                    "Accept": "application/json",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const errorText = await res.text();
                throw new Error(`Failed to create customer address: ${errorText}`);
            }

            return await res.json();
        };

        const createPlaceOrder = async (orderPayload) => {

            const res = await fetch(`${serverUrl}/api/orders/place_order`, {
                method: "POST",
                headers: {
                    "Accept": "application/json",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(orderPayload)
            });

            if (!res.ok) {
                const errorText = await res.text();
                throw new Error(`Failed to create order: ${errorText}`);
            }

            return await res.json();
        };

        const login = async (auth,pass) => {

            let loginPayload = {
                identifier: auth,
                password: pass,
                role: "CUSTOMER",
            };

            const res = await fetch(`${serverUrl}/auth/login`, {
                method: "POST",
                headers: {
                    "Accept": "application/json",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(loginPayload)
            });

            if (!res.ok) {
                const errorData = await res.json();
                const err = new Error(errorData.message);
                err.status = res.status;
                throw err;
            }
            return await res.json();
        };

        const register = async (auth,pass,role) => {

            let registerPayload = {
                email: auth,
                password: pass,
                role: role,
            };

            const res = await fetch(`${serverUrl}/auth/register`, {
                method: "POST",
                headers: {
                    "Accept": "application/json",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(registerPayload)
            });

            if (!res.ok) {
                const errorData = await res.json();
                const err = new Error(errorData.message);
                err.status = res.status;
                throw err;
            }
            return await res.json();
        };

        const fetchMerchants = async () => {
            const merchants = await fetch(`${serverUrl}/api/merchants`,{
                method: "GET",
                headers: { "Accept": "application/json" }
            });

            if (!merchants.ok) {
                throw new Error(`Fetch merchants failed: ${merchants.status} ${merchants.statusText}`);
            }

            return await merchants.json();
        };

        const fetchCustomer = async (customerID) => {
            const customer = await fetch(`${serverUrl}/api/customers/${customerID}`, {
                method: "GET",
                headers: { "Accept": "application/json" }
            });

            if (!customer.ok) {
                throw new Error(`Fetch customer failed: ${customer.status} ${customer.statusText}`);
            }

            const data = await customer.json();
            return data;
        };

        // --- Event Listeners ---
        presetCouponButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const code = btn.dataset.coupon;
                couponInput.value = code;
                applyCouponBtn.disabled = false;
            });
        });

        menuBackButton.addEventListener('click', () => {
            currentRestaurant = null;
            showSection('restaurant-list');
        });

        trackButton.addEventListener('click', () => {
            if (isOrderPlaced) {
                showSection('order-tracking-section');
            }
        });

        trackingBackButton.addEventListener('click', () => {
            showSection('restaurant-list'); 
            if (isOrderPlaced) {
                trackDot.classList.remove('hidden');
            }
        });

        profileButton.addEventListener('click', () => {
            const isProfileVisible = userProfileSection.style.display === 'block';
            const isAuthVisible = authSection.style.display === 'block';
            if (isProfileVisible || isAuthVisible) {
                showSection('restaurant-list');
            } else {
                if (isUserAuthenticated) {
                    showSection('user-profile');
                } else {
                    showSection('auth-section');
                }
            }
        });

        signoutButton.addEventListener('click', () => {
            isUserAuthenticated = false;
            localStorage.clear();
            showSection('auth-section');
        });

        orderButton.addEventListener('click', async () => {

            if (!isUserAuthenticated) {
                alert("Please sign in to place an order.");
                return;
            }

            const total = Number(cartTotalElement.textContent.replace('฿', ''));
            localStorage.setItem('total', total);
            const orderPayload = buildOrderPayload()

            try {
                const place_order = await createPlaceOrder(orderPayload);
                localStorage.setItem("place_order", JSON.stringify(place_order));

                const restaurantId = currentRestaurant.merchantId;
                localCart[restaurantId] = [];
                couponApplied = false;
                couponInput.value = '';
                couponStatus.textContent = '';
                applyCouponBtn.disabled = true;
                isOrderPlaced = true;

                renderCart();

                showModal();

                // Simulate status change
                setTimeout(() => setTrackingStep(2), 2000); // Food is being prepared
                setTimeout(() => setTrackingStep(3), 6000); // Rider is on the way
                setTimeout(() => setTrackingStep(4), 10000); // Delivered
            }catch (err){
                console.error("Order failed:", err);
                alert("Failed to place an order. Please try again."); // or show a small popup/modal    
            }
        });

        closeModalButton.addEventListener('click', hideModal);

        trackOrderButton.addEventListener('click', () => {
            hideModal();

            const order = JSON.parse(localStorage.getItem("place_order"));
            if (!order) return;

            trackingOrderId.textContent = `#${order.orderId}`;
            trackingRestaurantName.textContent = localStorage.getItem('selected_merchant_name');

            const tempRestaurant = {};
            currentRestaurant.menu.forEach(item => {
                tempRestaurant[item.itemId] = item.foodName
            });


            if (order.items && Array.isArray(order.items)) {
                order.items.forEach(item => {

                    const foodItemHtml = `
<div class="flex justify-between text-sm w-full"> 
<span>${tempRestaurant[item.itemId]}</span>
<span class="flex-shrink-0">x ${item.quantity}</span>
</div>
`;

                    trackingFoodItems.insertAdjacentHTML('beforeend', foodItemHtml);
                });
            }

            const total = localStorage.getItem('total');
            trackingOrderTotal.textContent = `฿${total}`;
            showSection('order-tracking-section');
        });

        menuContainer.addEventListener('click', (event) => {
            const targetButton = event.target.closest('.add-to-cart-btn');
            if (targetButton) {
                const foodItem = JSON.parse(targetButton.dataset.item);
                addToCart(foodItem);
            }
        });

        cartItemsContainer.addEventListener('click', (event) => {
            const targetButton = event.target.closest('.remove-from-cart-btn');
            if (targetButton) {
                const itemId = targetButton.dataset.itemId;
                removeFromCart(itemId);
            }
        });

        couponInput.addEventListener('input', () => {
            applyCouponBtn.disabled = couponInput.value.trim() === '';
        });



        applyCouponBtn.addEventListener('click', () => {
            const couponCode = couponInput.value.trim().toUpperCase();

            const coupons = {
                'SAVE10': { percent: 10, message: 'Coupon applied! You got 10% off.' },
                'SAVE20': { percent: 20, message: 'Coupon applied! You got 20% off.' },
                'SAVE30': { percent: 30, message: 'Coupon applied! You got 30% off.' },
                'SAVE40': { percent: 40, message: 'Coupon applied! You got 40% off.' },
                'SAVE50': { percent: 50, message: 'Coupon applied! You got 50% off.' },
                'FREEDELIVERY': { percent: 0, message: 'Coupon applied! Delivery fee waived.' }
            };

            const coupon = coupons[couponCode];

            if (coupon) {
                couponApplied = true;
                couponStatus.textContent = coupon.message;
                couponStatus.className = 'text-sm mt-2 text-pink-600';
                localStorage.setItem("applied_coupon", couponCode);
                localStorage.setItem("coupon_percent", coupon.percent);
            } else {
                couponApplied = false;
                couponStatus.textContent = 'Invalid coupon code. Please try again.';
                couponStatus.className = 'text-sm mt-2 text-red-500';
                localStorage.setItem("applied_coupon", "");
                localStorage.setItem("coupon_percent", 0);
            }

            updateCartTotals();
        });


        // Auth form listeners (simulated)
        showSignupLink.addEventListener('click', () => {

            signinForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
            showSignupLink.classList.add('hidden');
            showSigninLink.classList.remove('hidden');
            authStatus.textContent = '';
        });

        showSigninLink.addEventListener('click', () => {
            signupForm.classList.add('hidden');
            signinForm.classList.remove('hidden');
            showSigninLink.classList.add('hidden');
            showSignupLink.classList.remove('hidden');
            authStatus.textContent = '';
        });

        signupForm.addEventListener('submit', async (e) => {

            e.preventDefault();

            emailRegisterMsg.textContent = "";
            passRegisterMsg.textContent = "";

            const auth = signupEmailInput.value;
            const pass = signupPasswordInput.value;
            const roleInput = signupRoleSelect.value;

            let role = "";
            if (roleInput === "customer") {
                role = "ROLES_CUSTOMER"
            } else if (roleInput === "rider"){
                role = "ROLES_RIDER"
            }

            try {
                await register(auth, pass,role);
                showModalRegister();

                signupForm.classList.add('hidden');
                signinForm.classList.remove('hidden');
                showSigninLink.classList.add('hidden');
                showSignupLink.classList.remove('hidden');
                authStatus.textContent = '';

            } catch (error) {

                const cleanMsg = error.message.split(/:(.+)/)[1]?.trim() || "";
                const errors = cleanMsg.match(/(Email[^,]*|Password.*)/gi) || [];

                // console.error(error.stack);

                if (error.status == 409) {
                    emailRegisterMsg.textContent = "email already exists";
                    emailRegisterMsg.className = "text-sm mt-2 text-center text-red-500";
                    return;
                }

                if (errors.length === 0) {
                    registerMsg.textContent = "Signup failed. Please try again.";
                    registerMsg.className = "text-sm mt-2 text-center text-red-500";
                    return;
                }

                errors.forEach(err => {
                    if (err.toLowerCase().startsWith("email")) {
                        emailRegisterMsg.textContent = err;
                        emailRegisterMsg.className = `text-sm mt-2 text-center text-red-500`;
                    } else if (err.toLowerCase().startsWith("password")) {
                        passRegisterMsg.textContent = err;
                        passRegisterMsg.className = `text-sm mt-2 text-center text-red-500`;
                    }
                });


                return;
            };
        });

        signinForm.addEventListener('submit', async (e) => {

            e.preventDefault();

            const auth = signinEmailInput.value;
            const pass = signinPasswordInput.value;

            try {
                const loginResponse = await login(auth, pass);
                const accessToken = loginResponse.accessToken;
                const payload = decodeJwt(accessToken);

                if (!payload || !payload.ID) {
                    console.error('JWT payload is missing the required ID field.');
                    return; 
                }

                const customerIdFromToken = payload.ID;
                const customer = await fetchCustomer(customerIdFromToken); 
                localStorage.setItem("customer_id", customer.customerId);

                // localStorage.setItem("customer_addresses", JSON.stringify(customer.addresses));


                addresses = customer.addresses || [];
                if (addresses.length > 0) addresses[0].isDefault = true;

                isUserAuthenticated = true;


                profileButton.classList.remove('hidden');
                trackButton.classList.remove('hidden');
                apiButton.classList.remove('hidden');
                showSection('user-profile');
                renderAddresses();
                renderRestaurants();
                showSection('restaurant-list');

            } catch (error) {
                if (error.status === 400 ){
                    authStatus.textContent = "Login or password is invalid.";
                    authStatus.className = `text-sm mt-2 text-center text-red-500`;
                    return;
                }
                // console.error(error.stack);
                authStatus.textContent = "Login failed. Please try again.";
                authStatus.className = `text-sm mt-2 text-center text-red-500`;
                return;
            }
        });

        /**
            * Decodes the payload of a JSON Web Token (JWT).
            * @param {string} token The JWT string.
            * @returns {object|null} The decoded JSON payload, or null on failure.
        */
        const decodeJwt = (token) => {
            try {
                // The token is split into header, payload, and signature. We want the payload (index 1).
                const [_, base64Url] = token.split('.');
                if (!base64Url) return null;

                // Replace URL-safe characters with standard Base64 characters
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');

                // Decode Base64 and parse the resulting JSON string
                // The original logic is unnecessarily complex due to handling byte-by-byte decoding
                // Using `atob` for standard Base64 decoding, followed by a simple JSON.parse
                const jsonPayload = window.atob(base64);

                // NOTE: If the payload contains multi-byte characters (like emojis or non-latin text), 
                // the original `decodeURIComponent(window.atob(...))` logic is needed.
                // For a standard JWT with common claims, simple `atob` often works, but 
                // using a standard library (like `jwt-decode`) is best practice.
                // For safety/compatibility, here is the robust decoding:
                const payload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));

                return JSON.parse(payload);
            } catch (e) {
                console.error('Failed to decode or parse JWT payload:', e);
                return null;
            }
        };

        window.saveAddress = saveAddress;
        window.handleSaveAddress = handleSaveAddress;
        window.editAddress = editAddress;
        window.renderAddresses = renderAddresses;

        // Detect page refresh
        window.addEventListener('load', () => {
            const perfEntries = performance.getEntriesByType("navigation");
            const navType = perfEntries[0]?.type || performance.navigation.type;

            if (navType === "reload" || navType === 1) { // 1 = reload in older browsers
                console.log("Page was refreshed — clearing localStorage");
                localStorage.clear();
            }
        });


        // --- Initialization on page load ---
        document.addEventListener('DOMContentLoaded', async () => {

            document.getElementById('loader').classList.remove('hidden');
            cachedData = await fetchMerchants();
            document.getElementById('loader').classList.add('hidden');

            if (!isUserAuthenticated) {
                showSection('auth-section');
                return;
            }

        });

        </script>
    </body>
</html>

