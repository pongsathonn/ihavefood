 <!-- ----------------------------------------------------------------------------------------------- -->
 <!-- ---------------------------------------INDEX--------------------------------------------------- -->
 <!-- ----------------------------------------------------------------------------------------------- -->

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>IHAVEFOOD</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
        <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .restaurant-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .restaurant-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .food-item-card {
            transition: transform 0.2s;
        }
        .food-item-card:hover {
            transform: translateY(-2px);
        }
        /* Add a subtle animation for cart visibility */
        .fade-in-up {
            animation: fadeInUp 0.5s ease-in-out;
        }

        @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
        }
        .tracking-step.active .step-dot {
            background-color: #22c55e;
            transform: scale(1.2);
        }
        .tracking-step.active .step-line {
            background-color: #22c55e;
        }
        .tracking-step.active .step-text {
            font-weight: 600;
            color: #1f2937;
        }
        </style>
    </head>
    <body class="flex flex-col min-h-screen">

        <!-- Profile/Auth Button - Now fixed to the top-right of the viewport -->
        <button id="profile-button" class="fixed top-6 right-4 p-2 rounded-full bg-gray-200 hover:bg-gray-300 transition z-50">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
        </button>

        <!--  Main Content Container -->
        <div class="container mx-auto p-4 flex-grow grid grid-cols-1 md:grid-cols-3 gap-6">

            <!-- Header Section (Always Visible) -->
            <header id="main-header" class="text-center py-6 mb-6 relative col-span-1 md:col-span-3">
                <h1 class="text-5xl font-extrabold text-gray-900 tracking-tight">IHAVEFOOD</h1>
                <!-- <p class="text-xl text-gray-500 mt-2">Your favorite food, delivered fast.</p> -->
            </header>

            <!-- Food and Restaurant Content Section -->
            <main id="main-content" class="col-span-1 md:col-span-3">
                <!-- Restaurant List Section -->
                <section id="restaurant-list" class="bg-white p-6 rounded-3xl shadow-lg border border-grey-100 mb-6 hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Restaurants near you</h2>
                    <div id="restaurants-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Restaurant cards will be injected here by JavaScript -->
                        <p id="loading-message" class="text-gray-500 italic">Loading restaurants...</p>
                    </div>
                </section>

                <!-- Food Menu Section (Initially Hidden) -->
                <section id="food-menu" class="bg-white p-6 rounded-3xl shadow-lg border border-gray-100 hidden">
                    <div class="flex items-center mb-4">
                        <button id="menu-back-button" class="text-gray-500 hover:text-gray-700 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <h2 id="menu-title" class="text-2xl font-bold text-gray-800 ml-2"></h2>
                    </div>
                    <div id="menu-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Menu items will be injected here by JavaScript -->
                    </div>
                </section>

                <!-- Auth Section (Sign-up/Sign-in) -->
                <section id="auth-section" class="flex items-center justify-center p-6 bg-white rounded-3xl shadow-lg border border-gray-100 max-w-sm mx-auto hidden">
                    <div class="w-full">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Sign In</h2>

                        <div id="signin-form" class="space-y-4">
                            <p class="text-sm text-gray-500 text-center">This is a UI demonstration. The forms below are not functional.</p>
                            <div>
                                <label for="signin-email" class="block text-sm font-medium text-gray-700">Email or Phone Number</label>
                                <input type="email" id="signin-email-phone" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="signin-password" class="block text-sm font-medium text-gray-700">Password</label>
                                <input type="password" id="signin-password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <button id="signin-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200">
                                Sign In
                            </button>
                            <p id="auth-status" class="text-sm mt-2 text-red-500 text-center"></p>
                        </div>

                        <div id="signup-form" class="space-y-4 hidden">
                            <div>
                                <label for="signup-email" class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" id="signup-email" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="signup-password" class="block text-sm font-medium text-gray-700">Password</label>
                                <input type="password" id="signup-password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="signup-role" class="block text-sm font-medium text-gray-700">I am a...</label>
                                <select id="signup-role" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="customer">Customer</option>
                                    <option value="merchant">Merchant</option>
                                    <option value="rider">Rider</option>
                                </select>
                            </div>
                            <button id="signup-btn" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200">
                                Sign Up
                            </button>
                        </div>

                        <div class="mt-4 text-center text-sm">
                            <span id="show-signup" class="text-blue-500 hover:underline cursor-pointer">Don't have an account? Sign Up</span>
                            <span id="show-signin" class="text-blue-500 hover:underline cursor-pointer hidden">Already have an account? Sign In</span>
                        </div>

                    </div>
                </section>

                 <!-- User Profile Section (Initially Hidden) -->
                 <section id="user-profile" class="bg-white p-6 rounded-3xl shadow-lg border border-gray-100 hidden">
                     <!-- <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Customer Profile</h2> -->
                     <div class="flex flex-col items-center">
                         <!-- Profile Picture -->
                         <div class="w-32 h-32 rounded-full overflow-hidden mb-4 border-4 border-gray-200">
                             <img id="user-picture" src="https://placehold.co/128x128/94a3b8/fff?text=C" alt="User Profile Picture" class="w-full h-full object-cover">
                         </div>

                         <!-- Username -->
                         <p id="customer-name"
                             contenteditable="true"
                             class="text-xl font-semibold text-gray-800 mb-1 px-3 py-1 rounded-lg border border-transparent focus:outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-200 transition">
                             FooCustomer
                         </p>

                         <!-- Sign Out -->
                         <button id="signout-btn" class="mt-8 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-full transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-50">
                             Sign Out
                         </button>
                     </div>
                 </section>

                <!-- Order Tracking Section (Initially Hidden) -->
                <section id="order-tracking-section" class="bg-white p-6 rounded-3xl shadow-lg border border-gray-100 hidden col-span-1 md:col-span-3">
                    <div class="flex items-center mb-4">
                        <button id="tracking-back-button" class="text-gray-500 hover:text-gray-700 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <h2 class="text-2xl font-bold text-gray-800 ml-2">Order Tracking</h2>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                        <!-- Left Column: Map and Status -->
                        <div class="space-y-6">
                            <!-- Order Status -->
                            <div class="bg-gray-50 p-6 rounded-2xl border border-gray-200 shadow-sm">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">Order Status</h3>
                                <div class="flex items-center justify-between relative">
                                    <!-- Step 1: Placed -->
                                    <div class="tracking-step w-1/4 flex flex-col items-center relative active" id="step-1">
                                        <div class="step-dot w-6 h-6 rounded-full bg-pink-500 border-4 border-white transition-all duration-300"></div>
                                        <span class="step-text text-xs text-center text-gray-600 mt-2 transition-all duration-300">Order Placed</span>
                                    </div>
                                    <!-- Line 1 -->
                                    <div class="step-line absolute h-1 bg-gray-300 top-3 left-[12.5%] right-[62.5%] transition-all duration-300"></div>

                                    <!-- Step 2: Preparing -->
                                    <div class="tracking-step w-1/4 flex flex-col items-center relative" id="step-2">
                                        <div class="step-dot w-6 h-6 rounded-full bg-gray-300 border-4 border-white transition-all duration-300"></div>
                                        <span class="step-text text-xs text-center text-gray-600 mt-2 transition-all duration-300">Preparing Food</span>
                                    </div>
                                    <!-- Line 2 -->
                                    <div class="step-line absolute h-1 bg-gray-300 top-3 left-[37.5%] right-[37.5%] transition-all duration-300"></div>

                                    <!-- Step 3: On the Way -->
                                    <div class="tracking-step w-1/4 flex flex-col items-center relative" id="step-3">
                                        <div class="step-dot w-6 h-6 rounded-full bg-gray-300 border-4 border-white transition-all duration-300"></div>
                                        <span class="step-text text-xs text-center text-gray-600 mt-2 transition-all duration-300">Rider on the Way</span>
                                    </div>
                                    <!-- Line 3 -->
                                    <div class="step-line absolute h-1 bg-gray-300 top-3 left-[62.5%] right-[12.5%] transition-all duration-300"></div>

                                    <!-- Step 4: Delivered -->
                                    <div class="tracking-step w-1/4 flex flex-col items-center relative" id="step-4">
                                        <div class="step-dot w-6 h-6 rounded-full bg-gray-300 border-4 border-white transition-all duration-300"></div>
                                        <span class="step-text text-xs text-center text-gray-600 mt-2 transition-all duration-300">Delivered</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Map Placeholder -->
                            <div class="bg-gray-100 rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
                                <iframe 
                                    src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3778.6015525996613!2d98.98661797587186!3d18.80415516086701!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x30da3a817fe01f05%3A0xc317d7b27ed14b3d!2sChiang%20Mai%20International%20Airport!5e0!3m2!1sen!2sth!4v1716382022791!5m2!1sen!2sth" 
                                    width="100%" 
                                    height="400" 
                                    style="border:0;" 
                                    allowfullscreen="" 
                                    loading="lazy" 
                                    referrerpolicy="no-referrer-when-downgrade"
                                    class="rounded-2xl"
                                ></iframe>
                                <div class="p-4 bg-gray-50 text-center">
                                    <p class="text-sm text-gray-600">Map shows a placeholder location. A real app would track the rider's live location.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Order & Rider Details -->
                        <div class="space-y-6">
                            <!-- Order Summary -->
                            <div class="bg-gray-50 p-6 rounded-2xl border border-gray-200 shadow-sm">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">Order Details</h3>
                                <div class="space-y-2 text-gray-600 text-sm">
                                    <div class="flex justify-between">
                                        <span class="font-semibold">Order ID:</span>
                                        <span id="tracking-order-id">#1A2B3C4D</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="font-semibold">Restaurant:</span>
                                        <span id="tracking-restaurant-name">อร่อยดีตามสั่ง</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="font-semibold">Total:</span>
                                        <span id="tracking-order-total">฿200.00</span>
                                    </div>
                                    <!-- <div class="flex justify-between"> -->
                                    <!--     <span class="font-semibold">Est. Delivery:</span> -->
                                    <!--     <span id="tracking-eta">15-20 mins</span> -->
                                    <!-- </div> -->
                                </div>
                            </div>

                            <!-- Rider Information -->
                            <div class="bg-gray-50 p-6 rounded-2xl border border-gray-200 shadow-sm">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">Rider Information</h3>
                                <div class="flex items-center space-x-4">
                                    <img src="https://placehold.co/80x80/6366f1/fff?text=Rider" alt="Rider Profile" class="w-20 h-20 rounded-full object-cover">
                                    <div>
                                        <p class="text-lg font-semibold text-gray-800" id="rider-name">Demo Rider</p>
                                        <p class="text-sm text-gray-500" id="rider-vehicle">Honda Click 125i (กข1234)</p>
                                        <a href="tel:0812345678" class="text-blue-500 hover:underline text-sm flex items-center mt-1">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                            </svg>
                                            Call Rider
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <!-- Problem Reporting -->
                            <div class="bg-gray-50 p-6 rounded-2xl border border-gray-200 shadow-sm text-center">
                                <p class="text-sm text-gray-600 mb-3">Having an issue with your order?</p>
                                <button class="bg-red-500 text-white font-bold py-2 px-6 rounded-full hover:bg-red-600 transition">
                                    Report a Problem
                                </button>
                            </div>
                        </div>
                    </div>
                </section>

            </main>

            <!-- Shopping Cart Section (Initially Hidden) -->
            <aside id="cart-aside" class="col-span-1 hidden">
                <div class="bg-white p-6 rounded-3xl shadow-lg border border-gray-100 sticky top-40">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Cart</h2>
                    <div id="cart-items" class="min-h-[100px] mb-4">
                        <p id="empty-cart-message" class="text-gray-500 italic text-sm">Your cart is empty.</p>
                        <!-- Cart items will be injected here by JavaScript -->
                    </div>

                    <!-- Coupon Section -->
                    <div class="mt-4 mb-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Coupons</h3>

                        <div class="flex space-x-2 mt-2 mb-2">
                            <button class="preset-coupon-btn bg-gray-200 text-xs px-2 py-1 rounded hover:bg-gray-300" data-coupon="SAVE10">SAVE10</button>
                            <button class="preset-coupon-btn bg-gray-200 text-xs px-2 py-1 rounded hover:bg-gray-300" data-coupon="FREEDELIVERY">FREEDELIVERY</button>
                        </div>

                        <div class="flex items-center space-x-2">
                            <input type="text" id="coupon-input" placeholder="Enter coupon code" class="flex-grow p-2 rounded-lg border border-gray-300 focus:outline-none focus:border-blue-500">
                            <button id="apply-coupon-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition disabled:bg-gray-400" disabled>Apply</button>
                        </div>
                        <p id="coupon-status" class="text-sm mt-2"></p>
                    </div>

                    <div class="border-t pt-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-lg font-semibold text-gray-800">Food:</span>
                            <span id="cart-food" class="text-lg font-bold text-gray-600">฿0.00</span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-lg font-semibold text-gray-800">Delivery Fee:</span>
                            <span id="cart-delivery" class="text-lg font-bold text-gray-600">฿0.00</span>
                        </div>
                        <div id="discount-row" class="flex justify-between items-center mb-2 hidden">
                            <span class="text-lg font-semibold text-gray-800">Discount:</span>
                            <span id="cart-discount" class="text-lg font-bold text-red-500">-฿0.00</span>
                        </div>
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-lg font-semibold text-gray-800">Total:</span>
                            <span id="cart-total" class="text-xl font-bold text-pink-600">฿0.00</span>
                        </div>
                        <button id="order-button" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-full transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-pink-400 focus:ring-opacity-50 shadow-md disabled:bg-pink-400" disabled>
                            Place Order
                        </button>
                    </div>
                </div>
            </aside>

            <!-- Footer Credit -->
            <!-- <footer class="text-center py-4 text-xl text-gray-500"> credit </footer> -->

        </div>


        <!-- Order Confirmation Modal -->
        <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
            <div class="bg-white p-8 rounded-3xl shadow-lg w-full max-w-sm text-center">
                <svg class="mx-auto h-16 w-16 text-pink-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Order Placed!</h3>
                <p class="text-gray-600 mb-4">Your food is on its way. Thank you for your order!</p>
                <button id="track-order-button" class="bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200 mt-2 mr-2">
                    Track Order
                </button>
                <button id="close-modal-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200">
                    Close
                </button>
            </div>
        </div>

 <!-- ----------------------------------------------------------------------------------------------- -->
 <!-- ---------------------------------------JavaScript---------------------------------------------- -->
 <!-- ----------------------------------------------------------------------------------------------- -->

        <script>

        // --- Static Data (replaces Firestore) ---
        let isUserAuthenticated = false;
        // The cart is now an object, storing a separate cart array for each restaurant
        let localCart = {};
        let currentRestaurant = null;

        // --- UI Element References ---
        const mainContent = document.getElementById('main-content');
        const mainHeader = document.getElementById('main-header');
        const restaurantsContainer = document.getElementById('restaurants-container');
        const loadingMessage = document.getElementById('loading-message');
        const foodMenuSection = document.getElementById('food-menu');
        const userProfileSection = document.getElementById('user-profile');
        const restaurantListSection = document.getElementById('restaurant-list');
        const orderTrackingSection = document.getElementById('order-tracking-section');
        const authSection = document.getElementById('auth-section');
        const menuTitle = document.getElementById('menu-title');
        const menuContainer = document.getElementById('menu-container');
        const menuBackButton = document.getElementById('menu-back-button');
        const trackingBackButton = document.getElementById('tracking-back-button');
        const profileButton = document.getElementById('profile-button');
        const signoutButton = document.getElementById('signout-btn');
        const signinForm = document.getElementById('signin-form');
        const signupForm = document.getElementById('signup-form');
        const signinEmailPhoneInput = document.getElementById('signin-email-phone');
        const signinPasswordInput = document.getElementById('signin-password');
        const signupEmailPhoneInput = document.getElementById('signup-email');
        const signupPasswordInput = document.getElementById('signup-password');
        const signupRoleSelect = document.getElementById('signup-role');
        const signinBtn = document.getElementById('signin-btn');
        const infoEmail = document.getElementById('info-email');
        const infoPhone = document.getElementById('info-phone');
        const socialFacebook = document.getElementById('social-facebook');
        const socialInstagram = document.getElementById('social-instagram');
        const socialLine =  document.getElementById('social-line');
        const signupBtn = document.getElementById('signup-btn');

        const addPhoneBtn = document.getElementById('add-phone');

        const authStatus = document.getElementById('auth-status');
        const showSignupLink = document.getElementById('show-signup');
        const showSigninLink = document.getElementById('show-signin');
        const cartAside = document.getElementById('cart-aside');
        const cartItemsContainer = document.getElementById('cart-items');
        const cartFoodElement = document.getElementById('cart-food');
        const cartDeliveryElement = document.getElementById('cart-delivery');
        const cartDiscountElement = document.getElementById('cart-discount');
        const cartTotalElement = document.getElementById('cart-total');
        const discountRow = document.getElementById('discount-row');
        const orderButton = document.getElementById('order-button');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const modal = document.getElementById('modal');
        const closeModalButton = document.getElementById('close-modal-button');
        const trackOrderButton = document.getElementById('track-order-button');
        const couponInput = document.getElementById('coupon-input');
        const applyCouponBtn = document.getElementById('apply-coupon-btn');
        const couponStatus = document.getElementById('coupon-status');
        const userIdDisplay = document.getElementById('user-id');
        const trackingSteps = document.querySelectorAll('.tracking-step');

        const presetCouponButtons = document.querySelectorAll('.preset-coupon-btn');
        let couponApplied = false;
        let deliveryFeeApplied = false;

        // Detect page refresh
        window.addEventListener('load', () => {
            const perfEntries = performance.getEntriesByType("navigation");
            const navType = perfEntries[0]?.type || performance.navigation.type;

            if (navType === "reload" || navType === 1) { // 1 = reload in older browsers
                console.log("Page was refreshed — clearing localStorage");
                localStorage.clear();
            }
        });


        // --- UI Rendering Functions ---
        const showSection = (sectionId) => {
            const sections = [restaurantListSection, foodMenuSection, userProfileSection, authSection, orderTrackingSection];
            sections.forEach(section => {
                section.style.display = (section.id === sectionId) ? 'block' : 'none';
            });

            // Update the main content layout based on which section is visible
            if (sectionId === 'food-menu') {
                mainContent.classList.remove('md:col-span-3');
                mainContent.classList.add('md:col-span-2');
                cartAside.classList.remove('hidden');
            } else {
                mainContent.classList.remove('md:col-span-2');
                mainContent.classList.add('md:col-span-3');
                cartAside.classList.add('hidden');
            }
        };

        const renderRestaurants = (merchants) => {
            restaurantsContainer.innerHTML = '';
            loadingMessage.style.display = 'none';
            if (merchants.length === 0) {
                restaurantsContainer.innerHTML = '<p class="text-gray-500 italic">No restaurants available.</p>';
                return;
            }
            merchants.forEach(merchant => {
                const imageUrl = `${window.location.protocol}//${merchant.imageInfo.url}`;

                const card = document.createElement('div');
                const isClosed = merchant.status === 'CLOSED';
                card.className = `restaurant-card bg-gray-50 rounded-2xl shadow-sm overflow-hidden cursor-pointer hover:shadow-lg ${isClosed ? 'opacity-50 pointer-events-none' : ''}`;
                card.innerHTML = `
                    <img src="${imageUrl}" alt="${merchant.merchantName}" class="w-full h-[220px] object-cover">
                    <div class="p-4">
                        <h3 class="text-lg font-semibold text-gray-800">${merchant.merchantName}</h3>
                        <p class="text-sm text-gray-500">
                            Delivery: <span class="text-red-700">฿${merchant.deliveryFee}</span> <span class="text-gray-200">|</span> ${merchant.distance} km (${merchant.eta} min)
                        </p>
                        <p class="text-sm text-gray-500">Status: ${isClosed ? 'Closed' : 'Open'}</p>
                    </div>
                `;
                if (!isClosed) {
                    card.addEventListener('click', () => {
                        currentRestaurant = merchant;

                        localStorage.setItem('selected_merchant_id', merchant.merchantId);

                        menuTitle.textContent = currentRestaurant.merchantName;
                        renderMenu(currentRestaurant.menu);
                        renderCart(); // Render the cart for the selected restaurant
                        showSection('food-menu');
                    });
                }
                restaurantsContainer.appendChild(card);
            });
        };

        const renderMenu = (menu) => {
            menuContainer.innerHTML = '';
            if (!menu || menu.length === 0) {
                menuContainer.innerHTML = '<p class="text-gray-500 italic">This restaurant has no menu items.</p>';
                return;
            }
            menu.forEach(item => {
                const imageUrl = item.imageInfo?.url ? `${window.location.protocol}//${item.imageInfo.url}` : '';
                const card = document.createElement('div');
                card.className = 'food-item-card ...';

                card.innerHTML = `
                <div class="flex items-center space-x-4">
                    <img src="${imageUrl}" alt="${item.foodName}" class="w-16 h-16 object-cover rounded-lg">
                    <div>
                        <h4 class="text-md font-semibold text-gray-800">${item.foodName}</h4>
                        <span class="text-sm text-gray-500">฿${(item.price).toFixed(2)}</span>
                    </div>
                </div>
                <button class="add-to-cart-btn ..." data-item='${JSON.stringify(item)}'>Add</button>
                `;
                menuContainer.appendChild(card);
            });

        };

        const renderCart = () => {
            cartItemsContainer.innerHTML = '';
            const currentCart = localCart[currentRestaurant.merchantId] || [];

            if (currentCart.length === 0) {
                emptyCartMessage.style.display = 'block';
            } else {
                emptyCartMessage.style.display = 'none';
                currentCart.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'flex justify-between items-center py-2 border-b last:border-b-0 text-sm';
                    itemElement.innerHTML = `
                    <span>${item.foodName} <span class="text-gray-500">(${item.quantity})</span></span>
                    <div class="flex items-center space-x-2">
                        <span class="font-semibold">฿${(item.price * item.quantity).toFixed(2)}</span>
                        <button class="remove-from-cart-btn text-red-500 hover:text-red-600 transition" data-item-id="${item.itemId}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.038 21H7.962a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                    `;
                    cartItemsContainer.appendChild(itemElement);
                });
            }
            updateCartTotals();
        };

        const updateCartTotals = () => {
            const currentCart = localCart[currentRestaurant.merchantId] || [];


            // Food
            const food = currentCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            cartFoodElement.textContent = `฿${food.toFixed(2)}`;
            let discountAmount = 0;

            // Delivery Fee
            let deliveryFee = Number(currentRestaurant.deliveryFee) || 0;
            if (deliveryFeeApplied) {
                cartDeliveryElement.textContent = `-฿${deliveryFee.toFixed(2)}`;
                cartDeliveryElement.className = 'text-lg font-bold text-red-500';
                deliveryFee = 0; // Don't add to total
            } else {
                cartDeliveryElement.textContent = `฿${deliveryFee.toFixed(2)}`;
                cartDeliveryElement.className = 'text-lg font-bold text-gray-600';
            }

            // Discount
            if (couponApplied && couponPercent > 0) {
                discountAmount = food * (couponPercent / 100);
                discountRow.classList.remove('hidden');
                cartDiscountElement.textContent = `-฿${discountAmount.toFixed(2)}`;
            } else {
                discountRow.classList.add('hidden');
                cartDiscountElement.textContent = '-฿0.00';
            }

            total = food + deliveryFee - discountAmount
            cartTotalElement.textContent = `฿${total.toFixed(2)}`;
            orderButton.disabled = food === 0;
        };


        const addToCart = (foodItem) => {


            const restaurantId = currentRestaurant.merchantId;
            if (!localCart[restaurantId]) {
                localCart[restaurantId] = [];
            }
            const currentCart = localCart[restaurantId];
            const existingItem = currentCart.find(item => item.itemId === foodItem.itemId);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                currentCart.push({ ...foodItem, quantity: 1 });
            }

            renderCart();
        };

        const removeFromCart = (itemId) => {
            const restaurantId = currentRestaurant.merchantId;
            const currentCart = localCart[restaurantId] || [];
            const itemIndex = currentCart.findIndex(item => item.itemId === itemId);
            if (itemIndex !== -1) {
                const item = currentCart[itemIndex];
                if (item.quantity > 1) {
                    item.quantity--;
                } else {
                    currentCart.splice(itemIndex, 1);
                }
            }
            renderCart();
        };

        const showModal = () => {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        const hideModal = () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };

        const setTrackingStep = (stepNumber) => {
            trackingSteps.forEach((step, index) => {
                if (index < stepNumber) {
                    step.classList.add('active');
                    const line = step.nextElementSibling;
                    if (line && line.classList.contains('step-line')) {
                        line.classList.add('bg-green-500');
                        line.classList.remove('bg-gray-300');
                    }
                } else {
                    step.classList.remove('active');
                    const line = step.nextElementSibling;
                    if (line && line.classList.contains('step-line')) {
                        line.classList.remove('bg-green-500');
                        line.classList.add('bg-gray-300');
                    }
                }
            });
        };

        const createPlaceOrder = async () => {
            const restaurantId = currentRestaurant.merchantId;
            const customerId = localStorage.getItem('customer_id');
            const customerAddresses = JSON.parse(localStorage.getItem('customer_addresses') || "[]");
            const customerAddressId = customerAddresses[0]?.addressId; // or let user choose later

            const cartItems = (localCart[restaurantId] || []).map(item => ({
                item_id: item.itemId,
                quantity: item.quantity,
                note: item.note || ""
            }));

            const orderPayload = {
                request_id: crypto.randomUUID(),
                customer_id: customerId,
                merchant_id: restaurantId,
                items: cartItems,
                coupon_code: couponInput.value.trim() || null,
                customer_address_id: customerAddressId,
                payment_methods: "PAYMENT_METHOD_CREDIT_CARD"
            };

            console.log("payload before request",orderPayload);

            const res = await fetch("http://localhost/api/orders/place_order", {
                method: "POST",
                headers: {
                    "Accept": "application/json",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(orderPayload)
            });

            if (!res.ok) {
                const errorText = await res.text();
                throw new Error(`Failed to create order: ${errorText}`);
            }

            return await res.json();
        };

        const login = async (auth,pass) => {

             let loginPayload = {
                 identifier: auth,
                 password: pass,
                 role: "CUSTOMER",
             };

             const res = await fetch("http://localhost/auth/login", {
                 method: "POST",
                 headers: {
                     "Accept": "application/json",
                     "Content-Type": "application/json"
                 },
                 body: JSON.stringify(loginPayload)
             });

             if (!res.ok) {
                 const errorText = await res.text();
                 throw new Error(`Failed to make a login request: ${errorText}`);
             }

             return await res.json();
        };

        const fetchMerchants = async () => {
            const merchants = await fetch(`http://localhost/api/merchants`,{
                method: "GET",
                headers: { "Accept": "application/json" }
            });

             if (!merchants.ok) {
                 throw new Error(`Fetch merchants failed: ${merchants.status} ${merchants.statusText}`);
             }

             return await merchants.json();
        };

         const fetchCustomer = async (customerID) => {
             const customer = await fetch(`http://localhost/api/customers/${customerID}`, {
                 method: "GET",
                 headers: { "Accept": "application/json" }
             });

             if (!customer.ok) {
                 throw new Error(`Fetch customer failed: ${customer.status} ${customer.statusText}`);
             }

            const data = await customer.json();
            return data;
         };

        // --- Event Listeners ---
        presetCouponButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const code = btn.dataset.coupon;
                couponInput.value = code;
                applyCouponBtn.disabled = false;
            });
        });

        menuBackButton.addEventListener('click', () => {
            currentRestaurant = null;
            showSection('restaurant-list');
        });

        trackingBackButton.addEventListener('click', () => {
            showSection('restaurant-list');
        });

        profileButton.addEventListener('click', () => {
            const isProfileVisible = userProfileSection.style.display === 'block';
            const isAuthVisible = authSection.style.display === 'block';
            if (isProfileVisible || isAuthVisible) {
                showSection('restaurant-list');
            } else {
                if (isUserAuthenticated) {
                    showSection('user-profile');
                } else {
                    showSection('auth-section');
                }
            }
        });

        signoutButton.addEventListener('click', () => {
            isUserAuthenticated = false;
            localStorage.clear();
            showSection('auth-section');
        });

        orderButton.addEventListener('click', async () => {

            if (!isUserAuthenticated) {
                alert("Please sign in to place an order.");
                return;
            }

            try {
                const place_order = await createPlaceOrder();

                const restaurantId = currentRestaurant.merchantId;
                localCart[restaurantId] = [];
                couponApplied = false;
                couponInput.value = '';
                couponStatus.textContent = '';
                applyCouponBtn.disabled = true;
                renderCart();

                showModal();

                // Simulate status change
                setTimeout(() => setTrackingStep(2), 2000); // Food is being prepared
                setTimeout(() => setTrackingStep(3), 6000); // Rider is on the way
                setTimeout(() => setTrackingStep(4), 10000); // Delivered
            }catch (err){
                 console.error("Order failed:", err);
                 alert("Failed to place an order. Please try again."); // or show a small popup/modal    
             }
         });

        closeModalButton.addEventListener('click', hideModal);

        trackOrderButton.addEventListener('click', () => {
            hideModal();

            // TODO: get data before showing section.

            showSection('order-tracking-section');
        });

        menuContainer.addEventListener('click', (event) => {
            const targetButton = event.target.closest('.add-to-cart-btn');
            if (targetButton) {
                const foodItem = JSON.parse(targetButton.dataset.item);
                addToCart(foodItem);
            }
        });

        cartItemsContainer.addEventListener('click', (event) => {
            const targetButton = event.target.closest('.remove-from-cart-btn');
            if (targetButton) {
                const itemId = targetButton.dataset.itemId;
                removeFromCart(itemId);
            }
        });

        couponInput.addEventListener('input', () => {
            applyCouponBtn.disabled = couponInput.value.trim() === '';
        });

        applyCouponBtn.addEventListener('click', () => {
            const couponCode = couponInput.value.trim().toUpperCase();

            if (couponCode === 'SAVE10') {
                couponApplied = true;
                couponPercent = 10;
                couponStatus.textContent = 'Coupon applied! You got 10% off.';
                couponStatus.className = 'text-sm mt-2 text-pink-600';
            } 
            else if (couponCode === 'SAVE20') {
                couponApplied = true;
                couponPercent = 20;
                couponStatus.textContent = 'Coupon applied! You got 20% off.';
                couponStatus.className = 'text-sm mt-2 text-pink-600';
            } 
            else if (couponCode === 'SAVE30') {
                couponApplied = true;
                couponPercent = 30;
                couponStatus.textContent = 'Coupon applied! You got 30% off.';
                couponStatus.className = 'text-sm mt-2 text-pink-600';
            } 
            else if (couponCode === 'SAVE40') {
                couponApplied = true;
                couponPercent = 40;
                couponStatus.textContent = 'Coupon applied! You got 40% off.';
                couponStatus.className = 'text-sm mt-2 text-pink-600';
            } 
            else if (couponCode === 'SAVE50') {
                couponApplied = true;
                couponPercent = 50;
                couponStatus.textContent = 'Coupon applied! You got 50% off.';
                couponStatus.className = 'text-sm mt-2 text-pink-600';
            } 
            else if (couponCode === 'FREEDELIVERY') {
                deliveryFeeApplied = true;
                couponStatus.textContent = 'Coupon applied! Delivery fee waived.';
                couponStatus.className = 'text-sm mt-2 text-pink-600';
            } 
            else {
                couponApplied = false;
                couponStatus.textContent = 'Invalid coupon code. Please try again.';
                couponStatus.className = 'text-sm mt-2 text-red-500';
            }

            updateCartTotals();
        });

        // Auth form listeners (simulated)
        showSignupLink.addEventListener('click', () => {
            signinForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
            showSignupLink.classList.add('hidden');
            showSigninLink.classList.remove('hidden');
            authStatus.textContent = '';
        });

        // showSigninLink.addEventListener('click', () => {
        //     signupForm.classList.add('hidden');
        //     signinForm.classList.remove('hidden');
        //     showSigninLink.classList.add('hidden');
        //     showSignupLink.classList.remove('hidden');
        //     authStatus.textContent = '';
        // });

        signupBtn.addEventListener('click', () => {
            const email = signupEmailInput.value;
            isUserAuthenticated = true;
            showSection('restaurant-list');
        });

         signinBtn.addEventListener('click', async () => {
             const auth = signinEmailPhoneInput.value;
             const pass = signinPasswordInput.value;
             try {
                 const loginResponse = await login(auth, pass);
                 const accessToken = loginResponse.accessToken;
                 const payload = decodeJwt(accessToken);

                 if (!payload || !payload.ID) {
                     console.error('JWT payload is missing the required ID field.');
                     return; 
                 }
                 const customerIdFromToken = payload.ID;
                 const customer = await fetchCustomer(customerIdFromToken); 
                 localStorage.setItem("customer_id", customer.customerId);

                 localStorage.setItem("customer_addresses", JSON.stringify(customer.addresses));

                 isUserAuthenticated = true;

                showSection('restaurant-list');

             } catch (error) {
                 console.error('Error:', error.message, error.stack, error.response);
                 authStatus.textContent = "Login or password is invalid.";
                 authStatus.className = `text-sm mt-2 text-center text-red-500`;
                 return;
             }
         });

         /**
            * Decodes the payload of a JSON Web Token (JWT).
            * @param {string} token The JWT string.
            * @returns {object|null} The decoded JSON payload, or null on failure.
        */
         const decodeJwt = (token) => {
             try {
                 // The token is split into header, payload, and signature. We want the payload (index 1).
                 const [_, base64Url] = token.split('.');
                 if (!base64Url) return null;

                 // Replace URL-safe characters with standard Base64 characters
                 const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');

                 // Decode Base64 and parse the resulting JSON string
                 // The original logic is unnecessarily complex due to handling byte-by-byte decoding
                 // Using `atob` for standard Base64 decoding, followed by a simple JSON.parse
                 const jsonPayload = window.atob(base64);

                 // NOTE: If the payload contains multi-byte characters (like emojis or non-latin text), 
                 // the original `decodeURIComponent(window.atob(...))` logic is needed.
                 // For a standard JWT with common claims, simple `atob` often works, but 
                 // using a standard library (like `jwt-decode`) is best practice.
                 // For safety/compatibility, here is the robust decoding:
                 const payload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                     return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                 }).join(''));

                 return JSON.parse(payload);
             } catch (e) {
                 console.error('Failed to decode or parse JWT payload:', e);
                 return null;
             }
         };


        // --- Initialization on page load ---
        document.addEventListener('DOMContentLoaded', async () => {

            try {
                const data = await fetchMerchants();
                renderRestaurants(data.merchants);
                showSection('restaurant-list');
            } catch (error) {
                console.error("Failed to fetch merchants:", error);
                return;
            }

        });

        </script>
    </body>
</html>

